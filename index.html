<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Apex Automotive | M-Style Experience</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Exo+2:ital,wght@0,300;0,500;0,700;0,900;1,300&family=Rajdhani:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Three.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <style>
        :root {
            --primary: #14b8a6; /* Teal 500 */
            --primary-dark: #0f766e;
            --accent: #ef4444;  /* Red 500 */
            --accent-glow: rgba(239, 68, 68, 0.6);
            --dark: #111827;    /* Gray 900 */
            --dark-glass: rgba(17, 24, 39, 0.85);
        }
        
        body {
            font-family: 'Exo 2', sans-serif;
            background-color: var(--dark);
            /* Comic Book Halftone Pattern */
            background-image: 
                radial-gradient(var(--primary-dark) 15%, transparent 16%),
                radial-gradient(var(--primary-dark) 15%, transparent 16%);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
            color: white;
            overflow-x: hidden;
            margin: 0;
            
            /* Custom Red/Teal Cursor */
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" fill="%23111827" stroke="%23000" stroke-width="2"/><circle cx="16" cy="16" r="11" fill="none" stroke="%23ef4444" stroke-width="2" stroke-dasharray="2 3"/><circle cx="16" cy="16" r="4" fill="%2314b8a6"/><path d="M16 11 L16 21 M11 16 L21 16" stroke="%23fff" stroke-width="2"/></svg>') 16 16, auto;
        }

        /* Interactive Elements Pointer */
        a, button, input, select, .cursor-pointer {
            cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32"><circle cx="16" cy="16" r="13" fill="%23ef4444" stroke="%23fff" stroke-width="2"/><circle cx="16" cy="16" r="5" fill="%23fff"/><path d="M16 11 L16 21 M11 16 L21 16" stroke="%23ef4444" stroke-width="2"/></svg>') 16 16, pointer;
        }

        h1, h2, h3, .brand-font {
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        /* Cartoonish Header Style */
        h1 {
            font-family: 'Rajdhani', sans-serif;
            font-style: italic;
            text-shadow: 4px 4px 0px var(--primary-dark);
        }

        /* 3D Canvas fixed in background */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100vh;
            z-index: 0;
            pointer-events: all;
        }

        /* Content overlay */
        #content {
            position: relative;
            z-index: 10;
            /* CRITICAL: Allows clicks to pass through empty areas to the 3D canvas */
            pointer-events: none;
            transition: opacity 0.5s ease;
        }

        /* Re-enable pointer events for interactive UI elements */
        nav, section, footer, button, a, input, select, .glass-panel {
            pointer-events: auto;
        }

        /* Enhanced Glass Panel with Teal Border */
        .glass-panel {
            background: var(--dark-glass);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 2px solid var(--primary);
            box-shadow: 0 10px 0 0 rgba(0,0,0,0.5); /* Cartoon hard shadow */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            border-radius: 12px;
        }

        /* Cartoon Button */
        .btn-cartoon {
            position: relative;
            background: var(--primary);
            color: #000;
            border: 2px solid #fff;
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
            padding: 12px 24px;
            transform: skew(-10deg);
            box-shadow: 5px 5px 0px #000;
            transition: all 0.2s ease;
        }
        
        .btn-cartoon:hover {
            background: var(--accent);
            color: #fff;
            transform: skew(-10deg) translate(-2px, -2px);
            box-shadow: 7px 7px 0px #000;
        }

        .btn-cartoon-outline {
            position: relative;
            background: transparent;
            color: var(--primary);
            border: 2px solid var(--primary);
            font-weight: 800;
            text-transform: uppercase;
            padding: 12px 24px;
            transform: skew(-10deg);
            box-shadow: 5px 5px 0px rgba(20, 184, 166, 0.2);
            transition: all 0.2s ease;
        }
        
        .btn-cartoon-outline:hover {
            background: var(--primary);
            color: #000;
            box-shadow: 5px 5px 0px var(--accent);
            border-color: var(--accent);
        }

        /* Enhanced Service Card */
        .service-card {
            border: 2px solid var(--primary-dark);
            background: rgba(17, 24, 39, 0.9);
        }
        
        .service-card:hover {
            transform: translateY(-8px) scale(1.02);
            border-color: var(--accent);
            box-shadow: 0 15px 0 -5px var(--accent); /* Hard shadow */
        }

        .service-card svg {
            filter: drop-shadow(0 0 0 rgba(0,0,0,0));
            transition: 0.3s;
            color: var(--primary);
        }
        
        .service-card:hover svg {
            color: var(--accent);
            transform: scale(1.2) rotate(5deg);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 10px;
        }
        ::-webkit-scrollbar-track {
            background: #111827;
        }
        ::-webkit-scrollbar-thumb {
            background: var(--primary);
            border: 2px solid #111827;
            border-radius: 5px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent);
        }
        
        .fade-in-section {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .fade-in-section.is-visible {
            opacity: 1;
            transform: none;
        }
        
        /* Gradient Text */
        .text-gradient {
            background: linear-gradient(to right, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-style: italic;
        }

        /* GAME UI (Hidden by default) */
        #game-ui {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 50;
            pointer-events: none;
        }

        .game-hud {
            position: absolute;
            bottom: 2rem;
            right: 2rem;
            background: rgba(0,0,0,0.8);
            border: 2px solid var(--primary);
            padding: 1rem;
            border-radius: 10px;
            color: white;
            font-family: 'Rajdhani', sans-serif;
            pointer-events: auto;
        }

        .game-overlay {
            position: absolute;
            top: 2rem;
            left: 50%;
            transform: translateX(-50%);
            text-align: center;
            pointer-events: auto;
        }

        .key-hint {
            display: inline-block;
            background: #333;
            border: 1px solid #555;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            margin: 0 0.2rem;
            font-weight: bold;
            color: var(--primary);
        }

        .exit-btn {
            background: var(--accent);
            color: white;
            border: 2px solid white;
            padding: 0.5rem 1.5rem;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            border-radius: 4px;
            box-shadow: 4px 4px 0 black;
            transition: all 0.2s;
            pointer-events: auto;
        }
        .exit-btn:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 black;
        }
    </style>
</head>
<body>

    <!-- 3D Background Container -->
    <div id="canvas-container"></div>

    <!-- GAME UI LAYER -->
    <div id="game-ui">
        <div class="game-overlay">
            <h2 class="text-4xl font-black italic text-white mb-2" style="text-shadow: 2px 2px 0 var(--primary);">TEST DRIVE MODE</h2>
            <div class="bg-black/50 p-2 rounded backdrop-blur text-sm">
                Use <span class="key-hint">W</span> <span class="key-hint">A</span> <span class="key-hint">S</span> <span class="key-hint">D</span> or <span class="key-hint">ARROWS</span> to Drive
            </div>
            <button class="exit-btn mt-4" onclick="stopGame()">Exit Car</button>
        </div>
        <div class="game-hud">
            <div class="text-xl font-bold">SPEED: <span id="speed-meter" class="text-teal-400">0</span> KM/H</div>
        </div>
    </div>

    <!-- Main Content Overlay -->
    <div id="content">
        
        <!-- Navigation -->
        <nav class="glass-panel mx-4 mt-4 sticky top-4 border-b-0 z-50 rounded-xl">
            <div class="container mx-auto px-6 py-3 flex justify-between items-center">
                <div class="flex items-center space-x-2">
                    <!-- Simple SVG Icon -->
                    <svg class="w-8 h-8 text-teal-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    <span class="text-3xl font-black italic tracking-wider brand-font text-white" style="text-shadow: 2px 2px 0 var(--primary);">APEX<span class="text-red-500">M</span></span>
                </div>
                <div class="hidden md:flex space-x-8 text-sm font-bold tracking-wider items-center">
                    <a href="#home" class="hover:text-teal-400 transition-colors uppercase">Home</a>
                    <a href="#services" class="hover:text-teal-400 transition-colors uppercase">Services</a>
                    <a href="#tech" class="hover:text-teal-400 transition-colors uppercase">M-Power</a>
                    <a href="#contact" class="px-5 py-2 btn-cartoon text-xs no-underline">BOOK NOW</a>
                </div>
                <!-- Mobile Menu Button -->
                <button class="md:hidden text-white" onclick="alert('Menu toggled')">
                    <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                </button>
            </div>
        </nav>

        <!-- Hero Section -->
        <section id="home" class="min-h-screen flex items-center relative">
            <div class="container mx-auto px-6 grid grid-cols-1 md:grid-cols-2 gap-12">
                <div class="space-y-8 fade-in-section" style="z-index: 20;">
                    <div class="inline-flex items-center px-4 py-2 border-2 border-teal-500 bg-teal-900/50 rounded-lg text-teal-300 text-sm font-bold uppercase mb-2 transform -skew-x-12">
                        <span class="w-3 h-3 bg-red-500 mr-2 animate-bounce"></span>
                        Ultimate Driving Machine
                    </div>
                    <h1 class="text-6xl md:text-8xl font-black leading-none tracking-tighter">
                        STREET <br>
                        <span class="text-gradient" style="font-size: 1.1em;">DOMINANCE</span>
                    </h1>
                    <p class="text-gray-300 text-lg md:text-xl max-w-lg leading-relaxed border-l-4 border-red-500 pl-6 bg-black/20 py-2">
                        Specialized tuning for high-performance sedans. We turn stock into shock. <span class="text-teal-400 font-bold">CLICK THE CAR</span> to take it for a spin!
                    </p>
                    <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 pt-4">
                        <button onclick="document.getElementById('services').scrollIntoView({behavior: 'smooth'})" class="btn-cartoon">
                            Check Upgrades
                        </button>
                        <button class="btn-cartoon-outline">
                            View Gallery
                        </button>
                    </div>
                </div>
                <!-- Right side is empty to show the 3D car model -->
            </div>
        </section>

        <!-- Services Section -->
        <section id="services" class="py-32 relative">
            <div class="container mx-auto px-6">
                <div class="text-center mb-20 fade-in-section">
                    <h2 class="text-5xl font-black mb-4 italic text-white" style="text-shadow: 3px 3px 0 var(--primary);">GARAGE SERVICES</h2>
                    <div class="h-2 w-32 bg-red-500 mx-auto transform -skew-x-12"></div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <!-- Card 1 -->
                    <div class="glass-panel p-10 service-card fade-in-section group">
                        <div class="w-16 h-16 bg-teal-900 border-2 border-teal-500 rounded-lg flex items-center justify-center mb-6 shadow-lg transform rotate-3 group-hover:rotate-0 transition-transform">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.384-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-bold mb-3 text-white uppercase italic">Stage 2 Tuning</h3>
                        <p class="text-gray-400 font-medium">Push your V8 Twin Turbo to the limit with our aggressive ECU maps and downpipe installations.</p>
                    </div>

                    <!-- Card 2 -->
                    <div class="glass-panel p-10 service-card fade-in-section group" style="transition-delay: 100ms;">
                        <div class="w-16 h-16 bg-teal-900 border-2 border-teal-500 rounded-lg flex items-center justify-center mb-6 shadow-lg transform -rotate-2 group-hover:rotate-0 transition-transform">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </div>
                        <h3 class="text-2xl font-bold mb-3 text-white uppercase italic">Suspension Geometry</h3>
                        <p class="text-gray-400 font-medium">Laser alignment and coilover setup to ensure your M-Car handles like it's on rails.</p>
                    </div>

                    <!-- Card 3 -->
                    <div class="glass-panel p-10 service-card fade-in-section group" style="transition-delay: 200ms;">
                        <div class="w-16 h-16 bg-teal-900 border-2 border-teal-500 rounded-lg flex items-center justify-center mb-6 shadow-lg transform rotate-2 group-hover:rotate-0 transition-transform">
                            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
                        </div>
                        <h3 class="text-2xl font-bold mb-3 text-white uppercase italic">Custom Exhaust</h3>
                        <p class="text-gray-400 font-medium">Fabrication of titanium exhaust systems for that signature pops, bangs, and raw roar.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Section -->
        <section class="py-20 border-y-4 border-teal-500 bg-black/50 relative overflow-hidden">
            <div class="container mx-auto px-6 grid grid-cols-2 md:grid-cols-4 gap-8 text-center relative z-10">
                <div class="fade-in-section">
                    <div class="text-6xl font-black text-white mb-2 italic" style="-webkit-text-stroke: 2px var(--primary); color: transparent;">0-60</div>
                    <div class="text-red-500 text-sm font-bold uppercase tracking-widest bg-black inline-block px-2">2.8 Seconds</div>
                </div>
                <div class="fade-in-section">
                    <div class="text-6xl font-black text-white mb-2 italic" style="-webkit-text-stroke: 2px var(--primary); color: transparent;">HP</div>
                    <div class="text-red-500 text-sm font-bold uppercase tracking-widest bg-black inline-block px-2">625+ Tuned</div>
                </div>
                <div class="fade-in-section">
                    <div class="text-6xl font-black text-white mb-2 italic" style="-webkit-text-stroke: 2px var(--primary); color: transparent;">24h</div>
                    <div class="text-red-500 text-sm font-bold uppercase tracking-widest bg-black inline-block px-2">Turnaround</div>
                </div>
                <div class="fade-in-section">
                    <div class="text-6xl font-black text-white mb-2 italic" style="-webkit-text-stroke: 2px var(--primary); color: transparent;">100%</div>
                    <div class="text-red-500 text-sm font-bold uppercase tracking-widest bg-black inline-block px-2">Street Legal</div>
                </div>
            </div>
        </section>

        <!-- Contact Form -->
        <section id="contact" class="py-32">
            <div class="container mx-auto px-6">
                <div class="glass-panel max-w-5xl mx-auto rounded-none transform skew-x-[-2deg] flex flex-col md:flex-row fade-in-section border-4 border-white shadow-[10px_10px_0px_var(--primary)]">
                    <div class="p-12 md:w-5/12 bg-red-600 text-white flex flex-col justify-center relative overflow-hidden">
                        <h3 class="text-4xl font-black mb-6 italic uppercase">Start Your Build</h3>
                        <p class="mb-8 font-bold leading-relaxed relative z-10">Don't settle for stock. Book your consultation now and unleash the beast.</p>
                        
                        <div class="space-y-6 relative z-10 font-bold">
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl">üìû</span>
                                <span class="tracking-wide">+1 (555) M-POWER</span>
                            </div>
                            <div class="flex items-center space-x-4">
                                <span class="text-2xl">‚úâÔ∏è</span>
                                <span class="tracking-wide">builds@apex-m.com</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-12 md:w-7/12 bg-gray-900">
                        <form onsubmit="event.preventDefault(); alert('Request sent! We will contact you shortly.');" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-xs font-black text-teal-400 mb-2 uppercase tracking-wider">Name</label>
                                    <input type="text" class="w-full bg-gray-800 border-2 border-gray-700 rounded-none px-4 py-3 text-white focus:outline-none focus:border-teal-500 transition-colors placeholder-gray-600" placeholder="Driver Name">
                                </div>
                                <div>
                                    <label class="block text-xs font-black text-teal-400 mb-2 uppercase tracking-wider">Email</label>
                                    <input type="email" class="w-full bg-gray-800 border-2 border-gray-700 rounded-none px-4 py-3 text-white focus:outline-none focus:border-teal-500 transition-colors placeholder-gray-600" placeholder="email@example.com">
                                </div>
                            </div>
                            <div>
                                <label class="block text-xs font-black text-teal-400 mb-2 uppercase tracking-wider">Car Model</label>
                                <input type="text" class="w-full bg-gray-800 border-2 border-gray-700 rounded-none px-4 py-3 text-white focus:outline-none focus:border-teal-500 transition-colors placeholder-gray-600" placeholder="e.g. BMW M5 F90">
                            </div>
                            <button type="submit" class="w-full py-4 mt-2 btn-cartoon">
                                LAUNCH PROJECT
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </section>

        <footer class="bg-black py-8 border-t-4 border-teal-500 text-center text-gray-500 text-xs font-bold tracking-widest uppercase">
            <p>&copy; 2024 APEX M-DIVISION. <span class="text-red-500">NO SPEED LIMITS.</span></p>
        </footer>
    </div>

    <script>
        // --- Game State Variables ---
        let gameActive = false;
        let carGroup;
        let wheels = [];
        let shapesGroup;
        let gridHelper;
        let camera, scene, renderer;
        
        // Physics
        const physics = {
            speed: 0,
            acceleration: 0.5,
            friction: 0.98,
            maxSpeed: 2.0,
            rotationSpeed: 0.05,
            angle: 0
        };

        const keys = {
            w: false,
            a: false,
            s: false,
            d: false,
            ArrowUp: false,
            ArrowDown: false,
            ArrowLeft: false,
            ArrowRight: false
        };

        // --- 3D Scene Implementation ---
        const init3D = () => {
            const container = document.getElementById('canvas-container');
            scene = new THREE.Scene();
            
            // Comic/Toon Fog
            scene.fog = new THREE.Fog(0x111827, 8, 25);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            // Shadows for cartoon depth
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.BasicShadowMap; 
            container.appendChild(renderer.domElement);

            // Lighting for Toon Shader
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
            dirLight.position.set(10, 10, 10);
            dirLight.castShadow = true;
            dirLight.shadow.mapSize.width = 1024;
            dirLight.shadow.mapSize.height = 1024;
            scene.add(dirLight);

            // Rim light (Teal)
            const rimLight = new THREE.SpotLight(0x14b8a6, 5);
            rimLight.position.set(-5, 5, -5);
            rimLight.lookAt(0,0,0);
            scene.add(rimLight);

            // --- CAR CONSTRUCTION (Low Poly M5 Style) ---
            carGroup = new THREE.Group();

            // Materials (Toon)
            const bodyMat = new THREE.MeshToonMaterial({ color: 0xef4444 }); 
            const darkMat = new THREE.MeshToonMaterial({ color: 0x1f2937 }); 
            const glassMat = new THREE.MeshToonMaterial({ color: 0x14b8a6, opacity: 0.8, transparent: true }); 
            const wheelMat = new THREE.MeshToonMaterial({ color: 0x000000 });
            const rimMat = new THREE.MeshToonMaterial({ color: 0xcccccc });
            const lightMat = new THREE.MeshBasicMaterial({ color: 0xffffff }); 
            const tailLightMat = new THREE.MeshBasicMaterial({ color: 0xff0000 }); 

            // 1. Main Chassis
            const chassisGeo = new THREE.BoxGeometry(2, 0.7, 4.5);
            const chassis = new THREE.Mesh(chassisGeo, bodyMat);
            chassis.position.y = 0.7;
            chassis.castShadow = true;
            chassis.receiveShadow = true;
            chassis.name = "carBody"; // For raycaster
            carGroup.add(chassis);

            // 2. Cabin (Top)
            const cabinGeo = new THREE.BoxGeometry(1.7, 0.6, 2.5);
            const cabin = new THREE.Mesh(cabinGeo, glassMat); 
            cabin.position.set(0, 1.35, -0.2);
            cabin.castShadow = true;
            cabin.name = "carBody";
            carGroup.add(cabin);
            
            // Roof
            const roofGeo = new THREE.BoxGeometry(1.72, 0.05, 2.52);
            const roof = new THREE.Mesh(roofGeo, bodyMat); 
            roof.position.set(0, 1.65, -0.2);
            roof.name = "carBody";
            carGroup.add(roof);

            // 3. Wheels
            const wheelGeo = new THREE.CylinderGeometry(0.4, 0.4, 0.25, 24);
            const rimGeo = new THREE.CylinderGeometry(0.25, 0.25, 0.26, 8); 
            
            const wheelPositions = [
                { x: 1, z: 1.5 },   // Front Left
                { x: -1, z: 1.5 },  // Front Right
                { x: 1, z: -1.5 },  // Rear Left
                { x: -1, z: -1.5 }  // Rear Right
            ];

            wheelPositions.forEach(pos => {
                const wheelGroup = new THREE.Group();
                const tire = new THREE.Mesh(wheelGeo, wheelMat);
                tire.rotation.z = Math.PI / 2;
                tire.name = "carBody";
                
                const rim = new THREE.Mesh(rimGeo, rimMat);
                rim.rotation.z = Math.PI / 2;
                rim.name = "carBody";

                wheelGroup.add(tire);
                wheelGroup.add(rim);
                wheelGroup.position.set(pos.x, 0.4, pos.z);
                carGroup.add(wheelGroup);
                wheels.push(wheelGroup);
            });

            // M5 Details
            const grilleGeo = new THREE.BoxGeometry(0.3, 0.3, 0.1);
            const grilleL = new THREE.Mesh(grilleGeo, darkMat); grilleL.position.set(0.2, 0.8, 2.25); grilleL.name="carBody"; carGroup.add(grilleL);
            const grilleR = new THREE.Mesh(grilleGeo, darkMat); grilleR.position.set(-0.2, 0.8, 2.25); grilleR.name="carBody"; carGroup.add(grilleR);

            const headLightGeo = new THREE.BoxGeometry(0.4, 0.15, 0.1);
            const hlL = new THREE.Mesh(headLightGeo, lightMat); hlL.position.set(0.7, 0.85, 2.25); hlL.name="carBody"; carGroup.add(hlL);
            const hlR = new THREE.Mesh(headLightGeo, lightMat); hlR.position.set(-0.7, 0.85, 2.25); hlR.name="carBody"; carGroup.add(hlR);
            
            const spoilerGeo = new THREE.BoxGeometry(1.8, 0.05, 0.3);
            const spoiler = new THREE.Mesh(spoilerGeo, darkMat); spoiler.position.set(0, 1.1, -2.2); spoiler.rotation.x = 0.1; spoiler.name="carBody"; carGroup.add(spoiler);

            scene.add(carGroup);

            // --- Background Floating Elements ---
            shapesGroup = new THREE.Group();
            const shapeMat = new THREE.MeshToonMaterial({ color: 0x14b8a6 }); 
            const icoGeo = new THREE.IcosahedronGeometry(0.5, 0);
            for(let i=0; i<15; i++) {
                const mesh = new THREE.Mesh(icoGeo, shapeMat);
                mesh.position.set(
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 20,
                    (Math.random() - 0.5) * 10 - 5
                );
                mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0);
                shapesGroup.add(mesh);
            }
            scene.add(shapesGroup);

            // --- Grid for Driving ---
            gridHelper = new THREE.GridHelper(500, 100, 0x14b8a6, 0x1f2937);
            gridHelper.position.y = -0.1;
            gridHelper.visible = false;
            scene.add(gridHelper);

            // Camera setup
            camera.position.set(4, 2, 6);
            camera.lookAt(0, 0.5, 0);
            
            // Interaction State
            let mouseX = 0;
            let mouseY = 0;
            
            // Raycaster for click detection
            const raycaster = new THREE.Raycaster();
            const mouse = new THREE.Vector2();

            window.addEventListener('click', (event) => {
                if(gameActive) return;

                mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                
                raycaster.setFromCamera(mouse, camera);
                // Recursively check carGroup children
                const intersects = raycaster.intersectObjects(carGroup.children, true);
                
                if(intersects.length > 0) {
                    startGame();
                }
            });

            document.addEventListener('mousemove', (event) => {
                if(!gameActive) {
                    mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                    mouseY = -(event.clientY / window.innerHeight) * 2 + 1;
                }
            });

            // Key Handling
            window.addEventListener('keydown', (e) => { keys[e.key] = true; if(gameActive && e.key === "Escape") stopGame(); });
            window.addEventListener('keyup', (e) => { keys[e.key] = false; });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                if(!gameActive) resetCamera();
            });

            if(window.innerWidth < 768) {
                camera.position.set(0, 3, 7);
                camera.lookAt(0, 0, 0);
            }

            // Animation Loop
            const clock = new THREE.Clock();

            const animate = () => {
                requestAnimationFrame(animate);
                const time = clock.getElapsedTime();

                if(!gameActive) {
                    // --- Showroom Animation ---
                    carGroup.position.set(0, Math.sin(time * 1.5) * 0.05, 0); // Bobbing
                    carGroup.rotation.y = -Math.PI / 6 + Math.sin(time * 0.5) * 0.1 + (mouseX * 0.2); 
                    carGroup.rotation.x = Math.sin(time * 2) * 0.01 + (mouseY * 0.1); 
                    
                    // Spin wheels slightly
                    wheels.forEach(w => w.rotation.x += 0.05);

                    // Float Shapes
                    shapesGroup.children.forEach((child, i) => {
                        child.rotation.x += 0.01;
                        child.rotation.y += 0.01;
                        child.position.y += Math.sin(time + i) * 0.01;
                    });
                } else {
                    // --- Game Physics ---
                    
                    // Acceleration
                    if(keys.w || keys.ArrowUp) physics.speed += physics.acceleration * 0.1;
                    if(keys.s || keys.ArrowDown) physics.speed -= physics.acceleration * 0.1;
                    
                    // Friction
                    physics.speed *= physics.friction;
                    
                    // Steering (only when moving)
                    if(Math.abs(physics.speed) > 0.01) {
                        const dir = physics.speed > 0 ? 1 : -1;
                        if(keys.a || keys.ArrowLeft) carGroup.rotation.y += physics.rotationSpeed * dir;
                        if(keys.d || keys.ArrowRight) carGroup.rotation.y -= physics.rotationSpeed * dir;
                    }

                    // Move Car
                    carGroup.translateZ(physics.speed);

                    // Animate Wheels
                    wheels.forEach(w => w.rotation.x += physics.speed * 0.5);

                    // Camera Chase Logic
                    const relativeCameraOffset = new THREE.Vector3(0, 3, -8); // Behind car
                    const cameraOffset = relativeCameraOffset.applyMatrix4(carGroup.matrixWorld);
                    
                    // Smooth lerp
                    camera.position.lerp(cameraOffset, 0.1);
                    camera.lookAt(carGroup.position);

                    // Update HUD
                    document.getElementById('speed-meter').innerText = Math.abs(Math.round(physics.speed * 100));
                }

                renderer.render(scene, camera);
            };

            animate();
        };

        function resetCamera() {
            if(window.innerWidth < 768) {
                camera.position.set(0, 3, 7);
                camera.lookAt(0, 0, 0);
            } else {
                camera.position.set(4, 2, 6);
                camera.lookAt(0, 0.5, 0);
            }
        }

        function startGame() {
            gameActive = true;
            document.getElementById('content').style.opacity = '0';
            document.getElementById('content').style.pointerEvents = 'none';
            document.getElementById('game-ui').style.display = 'block';
            
            // Show Grid
            gridHelper.visible = true;
            shapesGroup.visible = false; // Hide clutter
            
            // Reset Physics
            physics.speed = 0;
            carGroup.rotation.set(0, Math.PI, 0); // Face away from camera initially
            carGroup.position.set(0, 0, 0);
        }

        window.stopGame = function() {
            gameActive = false;
            document.getElementById('content').style.opacity = '1';
            // Allow pointer events on buttons again (though the main container is none, children are auto)
            // No specific action needed as opacity handles visibility
            
            document.getElementById('game-ui').style.display = 'none';
            
            gridHelper.visible = false;
            shapesGroup.visible = true;

            // Reset Car position for showroom
            carGroup.position.set(0, 0, 0);
            resetCamera();
        };

        init3D();

        // Scroll Animation
        const observer = new IntersectionObserver((entries) => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('is-visible');
                }
            });
        }, { threshold: 0.1 });

        document.querySelectorAll('.fade-in-section').forEach(section => {
            observer.observe(section);
        });

    </script>
</body>
</html>
